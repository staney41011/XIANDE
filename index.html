<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset="UTF-8">
Â  <title>è³¢å¾·å¿—å£«</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  <link rel="manifest" href="manifest.json">
Â  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
Â Â 
Â  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
Â  <script>
Â  Â  const APP_VERSION = "20260109-FinalRestore-V2";Â 

Â  Â  (function checkUpdate() {
Â  Â  Â  const savedVersion = localStorage.getItem("app_version");
Â  Â  Â  if (savedVersion !== APP_VERSION) {
Â  Â  Â  Â  console.log(`æ›´æ–°ç‰ˆæœ¬: ${APP_VERSION}`);
Â  Â  Â  Â  if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(reg => reg.unregister()));
Â  Â  Â  Â  if ('caches' in window) caches.keys().then(n => n.forEach(k => caches.delete(k)));
Â  Â  Â  Â  localStorage.setItem("app_version", APP_VERSION);
Â  Â  Â  Â  setTimeout(() => window.location.reload(true), 500);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  })();

Â  Â  window.OneSignalDeferred = window.OneSignalDeferred || [];
Â  Â  OneSignalDeferred.push(function(OneSignal) {
Â  Â  Â  OneSignal.init({
Â  Â  Â  Â  appId: "2c0c1bb1-f413-474e-bc2d-45586547b981",Â 
Â  Â  Â  Â  notifyButton: { enable: true },
Â  Â  Â  Â  allowLocalhostAsSecureOrigin: true,
Â  Â  Â  Â  serviceWorkerPath: "OneSignalSDKWorker.js",
Â  Â  Â  });
Â  Â  });
Â  </script>

Â  <style>
Â  Â  /* CSS */
Â  Â  :root { --bg-color: #fdfbf7; --card-bg: #ffffff; --primary: #8bc34a; --accent: #ffb74d; --blue: #81d4fa; --red: #ff8a80; --text: #5d5d5d; --shadow: 0 4px 12px rgba(0,0,0,0.08); }
Â  Â  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
Â  Â  body { font-family: 'Varela Round', sans-serif; background: var(--bg-color); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;}
Â  Â  .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; height: 60px; padding-bottom: env(safe-area-inset-bottom); box-sizing: content-box; }
Â  Â  .nav-btn { background: none; border: none; color: #ccc; font-size: 10px; flex: 1; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
Â  Â  .nav-btn.active { color: var(--primary); transform: scale(1.1); transition: 0.2s;}
Â  Â  .nav-icon { font-size: 18px; margin-bottom: 2px; }
Â  Â  .viewport { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; width: 100%; padding-bottom: 100px; scroll-behavior: smooth;}
Â  Â  .top-nav { background: #fff; padding: 10px 15px; display: flex; flex-direction: column; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; flex-shrink: 0;}
Â  Â  .nav-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px;}
Â  Â  .card { background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 15px; width: 95%; max-width: 380px; border: 2px solid #fff; margin-left: auto; margin-right: auto; position: relative;}
Â  Â  .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; color: #fff; cursor: pointer; margin-top: 5px; box-shadow: 0 3px 0 rgba(0,0,0,0.1); }
Â  Â  .btn:active { transform: translateY(2px); box-shadow: none; }
Â  Â  .btn-primary { background: var(--blue); } .btn-success { background: var(--primary); } .btn-warn { background: var(--accent); }
Â  Â  .input-field { width: 100%; padding: 10px; margin: 5px 0; border: 2px solid #eee; border-radius: 10px; background: #fafafa; outline: none; font-family: inherit;}
Â  Â  .view-section { display: none; width: 100%; animation: fadeIn 0.3s; }Â 
Â  Â  .view-section.active { display: block; }
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  #auth-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0f7fa, #fff3e0); width: 100%; position: absolute; top:0; left:0; height: 100%; z-index: 200; }
Â  Â  #game-screen { display: none; height: 100%; flex-direction: column; width: 100%; }
Â  Â  .marquee-container { background: #d32f2f; color: #fff; font-size: 12px; white-space: nowrap; overflow: hidden; border-radius: 4px; padding: 2px 0; width: 100%; }
Â  Â  .marquee-text { display: inline-block; padding-left: 100%; animation: scroll 15s linear infinite; }
Â  Â  @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
Â  Â Â 
Â  Â  .orchard-dashboard { display: flex; justify-content: space-around; background: linear-gradient(135deg, #81c784, #4caf50); color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); width: 100%; }
Â  Â  .dash-item { text-align: center; }
Â  Â  .dash-num { font-size: 24px; font-weight: bold; display: block; }
Â  Â  .dash-label { font-size: 11px; opacity: 0.9; }
Â  Â  .orchard-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; padding-bottom: 20px;}
Â  Â  .tree-container { text-align: center; margin-bottom: 10px; cursor: pointer; transition: transform 0.1s; position: relative;}
Â  Â  .tree-container:active { transform: scale(0.95); }
Â  Â  .tree-canopy { background: #66bb6a; border-radius: 50% 50% 40% 40%; margin: 0 auto; padding: 5px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1); position: relative; transition: width 0.3s, height 0.3s; }
Â  Â  .tree-trunk { background: #8d6e63; margin: -2px auto 0 auto; border-radius: 0 0 5px 5px;}
Â  Â  .tree-scale-s .tree-canopy { width: 100px; min-height: 80px; } .tree-scale-s .tree-trunk { width: 15px; height: 20px; }
Â  Â  .tree-scale-m .tree-canopy { width: 130px; min-height: 100px; } .tree-scale-m .tree-trunk { width: 20px; height: 30px; }
Â  Â  .tree-scale-l .tree-canopy { width: 160px; min-height: 120px; } .tree-scale-l .tree-trunk { width: 25px; height: 40px; }
Â  Â  .tree-label { background: #fff; border: 1px solid #eee; padding: 4px 8px; border-radius: 8px; font-size: 12px; margin-top: 5px; display: inline-block; font-weight: bold; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); line-height: 1.4; min-width: 90px; }
Â  Â  .fruit { width: 12px; height: 12px; border-radius: 50%; margin: 2px; box-shadow: 1px 1px 2px rgba(0,0,0,0.2); flex-shrink: 0;}
Â  Â  .fruit.red { background: var(--red); } .fruit.gold { background: #ffd700; } .fruit.blue { background: #29b6f6; }Â 
Â  Â  .achieve-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 14px;}
Â  Â  .achieve-input-group { display: flex; align-items: center; gap: 8px; }
Â  Â  .achieve-input { width: 50px; text-align: center; border: 2px solid #eee; border-radius: 8px; padding: 5px; font-weight: bold; color: var(--text); background:#fafafa;}
Â  Â  .btn-plus { width: 32px; height: 32px; border-radius: 50%; border: none; background: #e8f5e9; color: var(--primary); font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
Â  Â  .btn-plus:active { background: #c8e6c9; transform: scale(0.9); }
Â  Â  .btn-minus { width: 32px; height: 32px; border-radius: 50%; border: none; background: #eee; color: #777; font-weight: bold; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
Â  Â  .btn-minus:active { background: #ddd; transform: scale(0.9); }
Â  Â  .today-dashboard { background: #f0f4c3; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 12px; color: #555; text-align: center; border: 1px solid #dce775; }
Â  Â  .calendar-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
Â  Â  .calendar-ctrl button { background: none; border: 1px solid #ddd; border-radius: 5px; padding: 2px 10px; cursor: pointer; color: #555; }
Â  Â  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; width: 100%; margin-top: 10px; min-height: 100px;}
Â  Â  .cal-day { aspect-ratio: 1; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 10px; background: #eee; color: #aaa; position: relative; overflow: hidden; }
Â  Â  .cal-fill-1 { background: #c8e6c9; color: #2e7d32; } .cal-fill-2 { background: #81c784; color: #1b5e20; } .cal-fill-3 { background: #4caf50; color: #fff; font-weight:bold; }
Â  Â  #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; }
Â  Â  .modal-box { background:#fff; padding:20px; border-radius:15px; width:85%; max-width:320px; max-height:80%; overflow-y:auto; position:relative; }
Â  Â  .modal-close { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#aaa; }
Â  Â  .log-item { padding: 10px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; text-align: left;}
Â  Â  .log-time { font-size: 10px; color: #999; width: 60px; flex-shrink: 0; margin-top: 2px;}
Â  Â  .log-content { font-size: 13px; color: #444; flex: 1;}
Â  Â  .log-tag { font-size: 10px; padding: 2px 4px; border-radius: 4px; background: #eee; margin-right: 5px; color: #666;}
Â  Â  .help-btn { position: absolute; top: 10px; right: 10px; width: 20px; height: 20px; border-radius: 50%; background: #eee; color: #999; font-size: 12px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
Â  Â  #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:3000; display:none; justify-content:center; align-items:center; flex-direction:column;}
Â  Â  .spinner { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
Â  Â  .profile-stats { margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px; font-size: 12px; line-height: 1.8; color: #555; }
Â  Â  .profile-logs { margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px; font-size: 12px; }
Â  Â  .profile-logs h5 { margin: 0 0 10px 0; color: #666; }
Â  Â  .admin-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:12px; align-items:center;}
Â  Â  .admin-stat-badges span { padding:2px 5px; border-radius:4px; font-size:10px; margin-left:3px; color:#fff;}
Â  Â  .member-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:12px; }
Â  Â  .filter-group { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
Â  Â  .filter-label { padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; cursor: pointer; color: #666; transition: all 0.2s; user-select: none; display: flex; align-items: center; }
Â  Â  .filter-label input { margin-right: 5px; }
Â  Â  .filter-label:has(input:checked) { background: var(--primary); color: #fff; border-color: var(--primary); }
Â  Â  .todo-list { margin-bottom: 15px; }
Â  Â  .todo-item { display: flex; align-items: center; background: #fff9c4; padding: 10px; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 2px 2px rgba(0,0,0,0.05); }
Â  Â  .todo-check { margin-right: 10px; width: 20px; height: 20px; cursor: pointer; }
Â  Â  .todo-text { flex: 1; font-size: 13px; color: #555; }
Â  Â  .crm-card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: transform 0.1s; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
Â  Â  .crm-card:active { transform: scale(0.98); }
Â  Â  .crm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
Â  Â  .crm-name { font-weight: bold; font-size: 14px; color: #333; }
Â  Â  .crm-status { font-size: 10px; padding: 3px 8px; border-radius: 10px; background: #eee; color: #666; }
Â  Â  .crm-status.s-plan { background: #e3f2fd; color: #1976d2; }
Â  Â  .crm-status.s-spoke { background: #fff3e0; color: #e64a19; }
Â  Â  .crm-status.s-join { background: #e8f5e9; color: #2e7d32; }
Â  Â  .crm-note { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  .fab { position: fixed; bottom: 80px; right: 20px; width: 50px; height: 50px; background: var(--accent); color: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 500; }
Â  Â  .sticky-filters { position: -webkit-sticky; position: sticky; top: 0; z-index: 900; background: var(--bg-color); padding: 10px 0; margin: 0 -15px; padding-left: 15px; padding-right: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }
Â  Â  .scroll-x { display: flex; overflow-x: auto; white-space: nowrap; gap: 8px; }
Â  Â  .chip { padding: 6px 12px; border-radius: 16px; background: #eee; color: #666; font-size: 12px; cursor: pointer; transition: 0.2s; border: 1px solid #ddd; }
Â  Â  .chip.active { background: var(--primary); color: #fff; font-weight: bold; border-color: var(--primary); }
Â  Â  .event-card { display: flex; background: #fff; margin-bottom: 10px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; transition: all 0.2s;}
Â  Â  .event-card.past { opacity: 0.6; filter: grayscale(80%); }
Â  Â  .event-card.focus { border: 2px solid var(--blue); box-shadow: 0 0 15px rgba(33, 150, 243, 0.4); transform: scale(1.02); }
Â  Â  .event-date-box { width: 60px; background: #f5f5f5; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; flex-shrink: 0; }
Â  Â  .event-day { font-size: 18px; font-weight: bold; color: #333; }
Â  Â  .event-month { font-size: 10px; color: #888; }
Â  Â  .event-info { padding: 10px; flex: 1; }
Â  Â  .event-title { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 4px; }
Â  Â  .event-note { font-size: 12px; color: #666; margin-bottom: 6px; border-left: 2px solid #eee; padding-left: 5px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
Â  Â  .event-meta { font-size: 11px; color: #777; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
Â  Â  .tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; color: #fff; background: #999; }
Â  Â  .tag.ä»™ä½›ç´€å¿µæ—¥ { background: #fbc02d; }
Â  Â  .tag.è³¢å¾· { background: #8bc34a; }
Â  Â  .tag.ä¸­å¤® { background: #ff7043; }
Â  Â  .tag.ä¸­è³¢, .tag.åŒ—è³¢, .tag.å—è³¢ { background: #29b6f6; }
Â  Â  .history-line { text-align: center; margin: 20px 0; color: #aaa; font-size: 12px; position: relative; }
Â  Â  .history-line::before, .history-line::after { content: ""; position: absolute; top: 50%; width: 35%; height: 1px; background: #eee; }
Â  Â  .history-line::before { left: 0; } .history-line::after { right: 0; }

Â  Â  /* åˆ†äº«å¡ (æ©«å‘) */
Â  Â  .share-scroll-x { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; scroll-snap-type: x mandatory; }
Â  Â  .share-card { min-width: 260px; max-width: 260px; background: #fff; border-radius: 12px; border: 1px solid #eee; padding: 15px; flex-shrink: 0; scroll-snap-align: start; display: flex; flex-direction: column; }
Â  Â  .share-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 8px; margin-bottom: 10px; background: #eee; }
Â  Â  .share-title { font-weight: bold; margin-bottom: 5px; color: #00c300; }
Â  Â  .share-text { background:#f1f8e9; padding:8px; border-radius:8px; font-size:12px; color:#555; margin-bottom:10px; max-height:60px; overflow-y:auto; flex: 1; }
Â  Â Â 
Â  Â  /* ä¸»é ˜ç­ CMS æ¨£å¼ */
Â  Â  .admin-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
Â  Â  .admin-menu-btn { padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
Â  Â  .admin-menu-btn:active { transform: scale(0.98); background: #fafafa; }
Â  Â  .admin-menu-icon { font-size: 24px; margin-bottom: 5px; display: block; }
Â  Â  .cms-item { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
Â  Â  .cms-item.inactive { opacity: 0.5; background: #f0f0f0; }
Â  Â  .cms-info { flex: 1; overflow: hidden; margin-right: 10px; }
Â  Â  .cms-title { font-weight: bold; font-size: 13px; margin-bottom: 2px; }
Â  Â  .cms-desc { font-size: 11px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  .cms-actions button { margin-left: 2px; padding: 5px 8px; font-size: 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
Â  Â  .preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; }
Â  Â  .preview-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; background: #eee; }
Â  </style>
</head>
<body>

Â  <div id="loading"><div class="spinner"></div><div style="margin-top:10px; font-size:12px; color:#888;">é€£ç·šä¸­...</div></div>
Â  <div id="modal-overlay" onclick="closeModal()"><div class="modal-box" onclick="event.stopPropagation()"><div class="modal-close" onclick="closeModal()">Ã—</div><h3 id="modal-title" style="margin-top:0; color:var(--primary);">è©³ç´°è³‡è¨Š</h3><div id="modal-content">Loading...</div></div></div>

Â  <div id="auth-screen">
Â  Â  <div style="font-size:26px; color:var(--text); margin-bottom:20px;">ğŸŒ³ è³¢å¾·å¿—å£«</div>
Â  Â  <div class="card">
Â  Â  Â  <div style="display:flex; margin-bottom:15px; border-bottom:1px solid #eee;">
Â  Â  Â  Â  <div onclick="toggleAuth('login')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:var(--primary); font-weight:bold;">ç™»å…¥</div>
Â  Â  Â  Â  <div onclick="toggleAuth('register')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#aaa;">è¨»å†Š</div>
Â  Â  Â  </div>
Â  Â  Â  <div id="f-login">
Â  Â  Â  Â  <input id="l-u" class="input-field" placeholder="æ±‚é“å">
Â  Â  Â  Â  <input id="l-p" type="password" class="input-field" placeholder="å¯†ç¢¼">
Â  Â  Â  Â  <button class="btn btn-primary" onclick="doLogin()">é€²å…¥æœåœ’</button>
Â  Â  Â  Â  <div style="text-align:center; margin-top:10px; font-size:12px; color:#aaa;">å¿˜è¨˜å¯†ç¢¼è«‹æ´½ç‘‹å€«</div>
Â  Â  Â  </div>
Â  Â  Â  <div id="f-reg" style="display:none;">
Â  Â  Â  Â  <input id="r-u" class="input-field" placeholder="è¨­å®šæ±‚é“å">
Â  Â  Â  Â  <input id="r-p" type="password" class="input-field" placeholder="è¨­å®šå¯†ç¢¼">
Â  Â  Â  Â  <select id="r-maj" class="input-field" onchange="updMinor()"><option>è¼‰å…¥ä¸­...</option></select>
Â  Â  Â  Â  <select id="r-min" class="input-field"><option>è«‹å…ˆé¸åœ˜éšŠ</option></select>
Â  Â  Â  Â  <button class="btn btn-success" onclick="doReg()">åŠ å…¥å¿—å£«</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="game-screen">
Â  Â  <div class="top-nav">
Â  Â  Â  <div class="nav-header"><span style="font-weight:bold; color:var(--primary); font-size:16px;">è³¢å¾·å¿—å£«</span><span id="ui-team" style="font-size:12px; color:#999;">--</span></div>
Â  Â  Â  <div class="marquee-container"><div id="marquee-text" class="marquee-text">æ­¡è¿å›åˆ°è³¢å¾·å¿—å£«ä¿®è¾¦ç³»çµ±ï¼</div></div>
Â  Â  </div>

Â  Â  <div class="viewport">
Â  Â  Â  <div id="v-home" class="view-section active">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â <div class="help-btn" onclick="alert('é»æ“Šã€Œé–‹å§‹è¨ˆæ™‚ã€ç´¯ç©è®€æ›¸æ™‚é–“ã€‚\né›¢é–‹ç¶²é æœƒè‡ªå‹•æš«åœã€‚')">?</div>
Â  Â  Â  Â  Â  Â <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><span>ğŸ“– è®€æ›¸è¨ˆæ™‚</span><span id="timer-display" style="font-size:20px; font-weight:bold; color:#ccc;">00:00</span></div>
Â  Â  Â  Â  Â  Â <button id="btn-timer" class="btn btn-primary" onclick="toggleTimer()">é–‹å§‹è¨ˆæ™‚</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="card" style="border-left: 5px solid #00c300;">
Â  Â  Â  Â  Â  Â <div class="help-btn" onclick="alert('å·¦æ»‘æŸ¥çœ‹æ›´å¤šã€‚\né»æ“ŠæŒ‰éˆ•å¯åŒæ™‚å–šèµ·åœ–ç‰‡èˆ‡æ–‡å­—åˆ†äº«ã€‚')">?</div>
Â  Â  Â  Â  Â  Â <h3 style="margin-top:0; color:#00c300; margin-bottom:15px;">ğŸ—£ï¸ æ–¹ä¾¿é–‹å£åŒ…</h3>
Â  Â  Â  Â  Â  Â <div id="share-loading" style="font-size:12px; color:#999; text-align:center;">è¼‰å…¥ä¸­...</div>
Â  Â  Â  Â  Â  Â <div id="share-container" class="share-scroll-x" style="display:none;"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" onclick="toggleSport()" style="display:flex; align-items:center; cursor:pointer;">
Â  Â  Â  Â  Â  Â <div class="help-btn" onclick="event.stopPropagation(); alert('é»æ“Šå¡ç‰‡å³å¯å®Œæˆä»Šæ—¥é‹å‹•æ‰“å¡ã€‚')">?</div>
Â  Â  Â  Â  Â  Â <div id="ck-sport" style="width:24px; height:24px; border-radius:50%; border:2px solid #ddd; margin-right:15px; display:flex; justify-content:center; align-items:center; color:#fff;">âœ“</div>
Â  Â  Â  Â  Â  Â <span>ğŸƒ æ¯æ—¥é‹å‹• 30 åˆ†é˜</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div class="help-btn" onclick="alert('é»æ“Šã€Œ+ã€æˆ–ã€Œ-ã€èª¿æ•´æ•¸é‡ã€‚\nä¸‹æ–¹å„€è¡¨æ¿æœƒå³æ™‚é¡¯ç¤ºä»Šæ—¥ç´¯ç©ã€‚\næœ€å¾Œè¨˜å¾—æŒ‰ã€Œç¢ºèªç´€éŒ„ã€åŒæ­¥åˆ°é›²ç«¯ã€‚')">?</div>
Â  Â  Â  Â  Â  <h3 style="margin-top:0; font-size:16px; color:var(--accent);">ğŸŒ± ä»Šæ—¥è€•è€˜æˆæœ</h3>
Â  Â  Â  Â  Â  <div class="achieve-row"><span>ğŸ—£ï¸ é–‹å£</span><div class="achieve-input-group"><button class="btn-minus" onclick="minusCount('inp-spoke')">-</button><input type="number" id="inp-spoke" class="achieve-input" value="0"><button class="btn-plus" onclick="addCount('inp-spoke')">+</button></div></div>
Â  Â  Â  Â  Â  <div class="achieve-row"><span>ğŸ¤ æ¸¡çœ¾</span><div class="achieve-input-group"><button class="btn-minus" onclick="minusCount('inp-conv')">-</button><input type="number" id="inp-conv" class="achieve-input" value="0"><button class="btn-plus" onclick="addCount('inp-conv')">+</button></div></div>
Â  Â  Â  Â  Â  <div class="achieve-row"><span>ğŸ« å…¥ç­</span><div class="achieve-input-group"><button class="btn-minus" onclick="minusCount('inp-class')">-</button><input type="number" id="inp-class" class="achieve-input" value="0"><button class="btn-plus" onclick="addCount('inp-class')">+</button></div></div>
Â  Â  Â  Â  Â  <div class="today-dashboard" id="today-dash">ğŸ“Š ä»Šæ—¥å·²ç´¯ç©ï¼šé–‹å£ 0 | æ¸¡çœ¾ 0 | å…¥ç­ 0</div>
Â  Â  Â  Â  Â  <button class="btn btn-success" onclick="saveAchievements()">âœ… ç¢ºèªç´€éŒ„</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="v-orchard" class="view-section" style="text-align:center;">
Â  Â  Â  Â  <button class="btn btn-primary" style="margin-bottom:15px; font-size:12px; padding:8px; width:auto;" onclick="loadOrchard()">ğŸ”„ æ›´æ–°æœåœ’æ•¸æ“š</button>
Â  Â  Â  Â  <div id="orchard-dash" class="orchard-dashboard">
Â  Â  Â  Â  Â  Â <div class="dash-item"><span id="dash-spoke" class="dash-num">0</span><span class="dash-label">ç¸½é–‹å£</span></div>
Â  Â  Â  Â  Â  Â <div class="dash-item"><span id="dash-conv" class="dash-num">0</span><span class="dash-label">ç¸½æ¸¡çœ¾</span></div>
Â  Â  Â  Â  Â  Â <div class="dash-item"><span id="dash-class" class="dash-num">0</span><span class="dash-label">ç¸½å…¥ç­</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="orchard-container" class="orchard-grid"></div>
Â  Â  Â  Â  <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
Â  Â  Â  Â  Â  Â <h4 style="color:#666;">ğŸ“œ æœ€æ–°å‹•æ…‹</h4>
Â  Â  Â  Â  Â  Â <div id="log-container" class="card" style="padding:0; overflow:hidden; width:100%; border:none; box-shadow:none; background:transparent;"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="v-crm" class="view-section">
Â  Â  Â  Â  Â <div class="card" style="background:#fffde7; border:1px solid #fff59d;">
Â  Â  Â  Â  Â  Â  <div class="help-btn" onclick="alert('é€™è£¡æœƒè‡ªå‹•åˆ—å‡ºæ‚¨åœ¨åå–®ä¸­å¡«å¯«çš„ã€Œä¸‹ä¸€æ­¥ã€ã€‚')">?</div>
Â  Â  Â  Â  Â  Â  <h3 style="margin-top:0; color:#fbc02d;">ğŸ“ å¾…è¾¦äº‹é …</h3>
Â  Â  Â  Â  Â  Â  <div id="crm-todo-list" class="todo-list"><div style="text-align:center; color:#999; font-size:12px;">ç„¡å¾…è¾¦äº‹é …</div></div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div style="padding:0 10px;">
Â  Â  Â  Â  Â  Â  <h3 style="color:#555; margin-bottom:10px;">ğŸ“‡ æ¸¡çœ¾åå–®</h3>
Â  Â  Â  Â  Â  Â  <div id="crm-list">è¼‰å…¥ä¸­...</div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div class="fab" onclick="editCRM(null)">+</div>
Â  Â  Â  </div>

Â  Â  Â  <div id="v-events" class="view-section">
Â  Â  Â  Â  Â <div style="padding: 0 10px;">
Â  Â  Â  Â  Â  Â  <div class="sticky-filters">
Â  Â  Â  Â  Â  Â  Â  Â <div id="event-filters" class="scroll-x"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="event-list" style="margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â <div style="text-align:center; padding:20px; color:#ccc;">è¼‰å…¥ä¸­...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="v-profile" class="view-section">
Â  Â  Â  Â  <div class="card" style="text-align:center;">
Â  Â  Â  Â  Â  Â <div class="help-btn" onclick="alert('é»æ“Šã€Œç™»å‡ºã€å¯åˆ‡æ›å¸³è™Ÿã€‚')">?</div>
Â  Â  Â  Â  Â  Â <div style="font-size:40px;">ğŸ§‘â€ğŸŒ¾</div>
Â  Â  Â  Â  Â  Â <h3 id="p-job">ä¿®é“å¿—å£«</h3>
Â  Â  Â  Â  Â  Â <div style="margin-top:15px; text-align:left;"><label style="font-size:12px;">â° è¨­å®šã€Œè¨˜å¾—ä¸Šç·šã€æé†’ï¼š</label><input type="time" id="reminder-time" class="input-field" onchange="setLocalReminder()"></div>
Â  Â  Â  Â  Â  Â <button class="btn btn-warn" onclick="logout()" style="width:100%; margin-top:15px; font-size:12px;">ç™»å‡º</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â <div class="calendar-ctrl"><button onclick="changeMonth(-1)">&lt;</button><span id="cal-title" style="font-weight:bold;">--</span><button onclick="changeMonth(1)">&gt;</button></div>
Â  Â  Â  Â  Â  Â <div id="calendar-area" class="calendar-grid"></div>
Â  Â  Â  Â  Â  Â <div id="profile-stats" class="profile-stats"></div>
Â  Â  Â  Â  Â  Â <div class="profile-logs"><h5>ğŸ“… æœ¬æœˆæ˜ç´°</h5><div id="profile-log-list"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="v-admin" class="view-section">
Â  Â  Â  Â  Â <div class="card">
Â  Â  Â  Â  Â  Â <h3>ğŸ›¡ï¸ ä¸»é ˜ç­å„€è¡¨æ¿</h3>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <div class="admin-menu-grid">
Â  Â  Â  Â  Â  Â  Â  <div class="admin-menu-btn" onclick="switchAdminView('promo')">
Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="admin-menu-icon">ğŸ–¼ï¸</span>å®£å‚³ç®¡ç†
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="admin-menu-btn" onclick="switchAdminView('broadcast')">
Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="admin-menu-icon">ğŸ“¢</span>å…¨å“¡å»£æ’­
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="admin-menu-btn" onclick="switchAdminView('report')">
Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="admin-menu-icon">ğŸ“Š</span>æ•¸æ“šå ±è¡¨
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â <div id="adm-view-promo" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  <h4 style="border-bottom:1px solid #eee; padding-bottom:5px;">å®£å‚³å…§å®¹ç®¡ç†</h4>
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-success" style="margin-bottom:15px;" onclick="openCmsModal('add')">+ æ–°å¢å®£å‚³å…§å®¹</button>
Â  Â  Â  Â  Â  Â  Â  <div id="cms-list">è¼‰å…¥ä¸­...</div>
Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â <div id="adm-view-broadcast" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  <h4 style="border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ“¢ ç™¼é€å»£æ’­</h4>
Â  Â  Â  Â  Â  Â  Â  <div style="background:#e3f2fd; padding:10px; border-radius:10px; margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">è·‘é¦¬ç‡ˆ (ä¸Šæ–¹æ»¾å‹•)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <input id="adm-marquee" class="input-field" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹...">
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="btn btn-warn" style="font-size:12px; padding:8px;" onclick="updateMarquee()">æ›´æ–°å…¬å‘Š</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <textarea id="broadcast-msg" class="input-field" rows="3" placeholder="æ¨æ’­å…§å®¹ (æ‰‹æ©Ÿé€šçŸ¥)"></textarea>
Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:5px; font-size:12px; color:#666;"><label>é ç´„ç™¼é€ (é¸å¡«)ï¼š</label><input type="datetime-local" id="broadcast-time" class="input-field"></div>
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-warn" onclick="sendBroadcast()">ç™¼é€æ¨æ’­</button>
Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â <div id="adm-view-report" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  <h4 style="border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ“Š æ•¸æ“šæŸ¥è©¢</h4>
Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom:15px; display:flex; gap:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="adm-mode" class="input-field" onchange="toggleAdmDateInput()" style="flex:1;"><option value="all">å…¨éƒ¨æ­·å²</option><option value="date">æŒ‡å®šæ—¥æœŸ</option><option value="month">æŒ‡å®šæœˆä»½</option></select>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="adm-date-box" style="flex:1; display:none;"><input type="date" id="adm-date" class="input-field"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="adm-month-box" style="flex:1; display:none;"><input type="month" id="adm-month" class="input-field"></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:5px; margin-bottom:10px;"><select id="adm-maj" class="input-field" onchange="admUpdMin()"><option value="å…¨éƒ¨">å…¨éƒ¨åœ˜éšŠ</option></select><select id="adm-min" class="input-field"><option value="å…¨éƒ¨">å…¨éƒ¨å…¬å ‚</option></select></div>
Â  Â  Â  Â  Â  Â  Â  <div class="filter-group" style="margin-bottom:15px;">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="filter-label"><input type="checkbox" id="f-sport">ğŸƒ é‹å‹•</label>
Â  Â  Â  Â  Â  Â  Â  Â  <label class="filter-label"><input type="checkbox" id="f-read">ğŸ“– è®€æ›¸</label>
Â  Â  Â  Â  Â  Â  Â  Â  <label class="filter-label"><input type="checkbox" id="f-spoke">ğŸ—£ï¸ é–‹å£</label>
Â  Â  Â  Â  Â  Â  Â  Â  <label class="filter-label"><input type="checkbox" id="f-conv">ğŸ¤ æ¸¡çœ¾</label>
Â  Â  Â  Â  Â  Â  Â  Â  <label class="filter-label"><input type="checkbox" id="f-class">ğŸ« å…¥ç­</label>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="runAdminQuery()">ğŸ” æŸ¥è©¢å ±è¡¨</button>
Â  Â  Â  Â  Â  Â  Â  <div id="admin-report" class="admin-report-box" style="display:none; margin-top:15px;"></div>
Â  Â  Â  Â  Â  Â  Â  <div id="admin-list" style="margin-top:10px;"></div>
Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="bottom-nav">
Â  Â  Â  <button class="nav-btn active" onclick="nav('home')" id="n-home"><span class="nav-icon">ğŸ“</span>ä¿®ç…‰</button>
Â  Â  Â  <button class="nav-btn" onclick="nav('orchard'); loadOrchard()" id="n-orchard"><span class="nav-icon">ğŸ</span>æœåœ’</button>
Â  Â  Â  <button class="nav-btn" onclick="nav('crm'); loadCRM()" id="n-crm"><span class="nav-icon">ğŸ“’</span>è¨˜äº‹</button>
Â  Â  Â  <button class="nav-btn" onclick="nav('events'); loadEvents()" id="n-events"><span class="nav-icon">ğŸ“…</span>æ´»å‹•</button>
Â  Â  Â  <button class="nav-btn" onclick="nav('profile'); loadCalendar()" id="n-profile"><span class="nav-icon">ğŸ‘¤</span>æˆ‘çš„</button>
Â  Â  Â  <button class="nav-btn" onclick="nav('admin'); loadAdminFilters()" id="n-admin" style="display:none;"><span class="nav-icon">ğŸ›¡ï¸</span>ä¸»é ˜ç­</button>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // ğŸ”´ è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ Web App URL
Â  Â  const API_URL = "https://script.google.com/macros/s/AKfycbxHe88NVoiJkAt2pvBnCYUk_xGul1FhXTAj0kyAXA9GEIddXB1AD8j4gtjhbDEASPSr/exec";
Â  Â Â 
Â  Â  var gUser=null, gPass=null, gData={}, menuConfig={}, crmData=[];
Â  Â  var allEvents = [], activeFilters = [], shareDataList = [];
Â  Â  var cmsUploadFiles = [];Â 
Â  Â  var timerInt=null, isTimer=false;
Â  Â  var curYear = new Date().getFullYear(), curMonth = new Date().getMonth() + 1;

Â  Â  // ... Init ...
Â  Â  setInterval(function(){
Â  Â  Â  var setTime = localStorage.getItem("reminder_time");
Â  Â  Â  if(!setTime) return;
Â  Â  Â  var now = new Date();
Â  Â  Â  var nowStr = (now.getHours()<10?'0':'') + now.getHours() + ":" + (now.getMinutes()<10?'0':'') + now.getMinutes();
Â  Â  Â  var lastRemind = localStorage.getItem("last_remind_date");
Â  Â  Â  var today = now.toDateString();
Â  Â  Â  if (nowStr === setTime && lastRemind !== today) {
Â  Â  Â  Â  Â localStorage.setItem("last_remind_date", today);
Â  Â  Â  Â  Â if(Notification.permission === 'granted') new Notification("è³¢å¾·å¿—å£«", { body: "â° æ™‚é–“åˆ°äº†ï¼" });
Â  Â  Â  }
Â  Â  }, 60000);Â 

Â  Â  window.onload = function(){
Â  Â  Â  Â  loading(true);
Â  Â  Â  Â  var d = new Date();
Â  Â  Â  Â  document.getElementById('adm-date').valueAsDate = d;
Â  Â  Â  Â  var mStr = d.getFullYear() + "-" + ((d.getMonth()+1)<10?"0"+(d.getMonth()+1):(d.getMonth()+1));
Â  Â  Â  Â  document.getElementById('adm-month').value = mStr;

Â  Â  Â  Â  callApi('getConfig').then(cfg => {
Â  Â  Â  Â  Â  Â  menuConfig = cfg.menu;
Â  Â  Â  Â  Â  Â  if(cfg.announcement) document.getElementById('marquee-text').innerText = cfg.announcement;
Â  Â  Â  Â  Â  Â  initRegDropdowns();
Â  Â  Â  Â  Â  Â  initAdminDropdowns();
Â  Â  Â  Â  Â  Â  var u = localStorage.getItem("xd_u"), p = localStorage.getItem("xd_p");
Â  Â  Â  Â  Â  Â  if(u&&p){ document.getElementById('l-u').value=u; document.getElementById('l-p').value=p; doLogin(); } else { loading(false); }
Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  loading(false);
Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  alert("é€£ç·šåˆå§‹åŒ–å¤±æ•—: " + err);
Â  Â  Â  Â  });
Â  Â  Â  Â  var savedTime = localStorage.getItem("reminder_time");
Â  Â  Â  Â  if(savedTime) document.getElementById('reminder-time').value = savedTime;
Â  Â  }

Â  Â  // ğŸ”´ æ ¸å¿ƒé€šè¨Šå‡½å¼ï¼šä½¿ç”¨ç´” JSON Body (å°æ‡‰å¾Œç«¯æœ€æ–°è§£æé‚è¼¯)
Â  Â  function callApi(action, params) {
Â  Â  Â  Â  if(!params) params = {};
Â  Â  Â  Â  params.action = action;
Â  Â  Â  Â Â 
Â  Â  Â  Â  return fetch(API_URL, {Â 
Â  Â  Â  Â  Â  Â  method: 'POST',Â 
Â  Â  Â  Â  Â  Â  // ä¸æŒ‡å®š headerï¼Œä½¿ç”¨é è¨­ text/plainï¼Œé¿é–‹ CORS preflight
Â  Â  Â  Â  Â  Â  body: JSON.stringify(params)Â 
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  .then(json => {
Â  Â  Â  Â  Â  Â  if(json.error) {
Â  Â  Â  Â  Â  Â  Â  Â console.error("API Error:", json);
Â  Â  Â  Â  Â  Â  Â  Â if(json.error.includes("Backend")) alert("ç³»çµ±éŒ¯èª¤: " + json.error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return json;
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  function loading(x){ document.getElementById('loading').style.display = x?'flex':'none'; }

Â  Â  // ... Share Logic ...
Â  Â  function loadShareData() {
Â  Â  Â  Â var isAdmin = (gData.teamMajor === "ä¸»é ˜ç­");
Â  Â  Â  Â callApi('getShareData', {isAdmin: isAdmin}).then(res => {
Â  Â  Â  Â  Â  document.getElementById('share-loading').style.display = 'none';
Â  Â  Â  Â  Â  shareDataList = res.list || [];
Â  Â  Â  Â  Â  if(isAdmin) renderCmsList();
Â  Â  Â  Â  Â  var activeList = shareDataList.filter(item => item.isActive);
Â  Â  Â  Â  Â  if(activeList.length === 0) {
Â  Â  Â  Â  Â  Â  Â document.getElementById('share-loading').innerText = "ğŸ“­ ç›®å‰æ²’æœ‰æ¨å»£å…§å®¹";
Â  Â  Â  Â  Â  Â  Â document.getElementById('share-loading').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â document.getElementById('share-container').innerHTML = "";
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  document.getElementById('share-container').style.display = 'flex';
Â  Â  Â  Â  Â  var html = "";
Â  Â  Â  Â  Â  activeList.forEach((item, index) => {
Â  Â  Â  Â  Â  Â  Â var originalIndex = shareDataList.indexOf(item);
Â  Â  Â  Â  Â  Â  Â var firstImg = (item.images && item.images.length>0) ? item.images[0] : "";
Â  Â  Â  Â  Â  Â  Â var imgHtml = firstImg ? `<img src="${firstImg}" class="share-img">` : `<div style="text-align:center; color:#ccc; padding:20px; background:#f5f5f5; border-radius:8px; margin-bottom:10px;">ç„¡åœ–ç‰‡</div>`;
Â  Â  Â  Â  Â  Â  Â html += `<div class="share-card">${imgHtml}<div class="share-title">${item.title}</div><div class="share-text">${item.text}</div><div style="display:flex; gap:5px;"><button class="btn" style="flex:1; background:#fff; color:#555; border:1px solid #ddd; font-size:11px;" onclick="copyShareText(${originalIndex})">ğŸ“‹ è¤‡è£½æ–‡å­—</button><button class="btn" style="flex:1; background:#00c300; color:#fff; font-size:11px;" onclick="nativeShare(${originalIndex})">ğŸ’¬ åˆ†äº«</button></div></div>`;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  document.getElementById('share-container').innerHTML = html;
Â  Â  Â  Â });
Â  Â  }

Â  Â  function copyShareText(index) {
Â  Â  Â  Â var text = shareDataList[index].text;
Â  Â  Â  Â navigator.clipboard.writeText(text).then(() => alert("æ–‡å­—å·²è¤‡è£½ï¼"));
Â  Â  }

Â  Â  async function nativeShare(index) {
Â  Â  Â  Â var item = shareDataList[index];
Â  Â  Â  Â try { await navigator.clipboard.writeText(item.text); } catch(e){}
Â  Â  Â  Â var filesArray = [];
Â  Â  Â  Â if(item.images && item.images.length > 0) {
Â  Â  Â  Â  Â  loading(true);
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â for(var i=0; i<item.images.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  var url = item.images[i];
Â  Â  Â  Â  Â  Â  Â  Â  var blob = await fetch(url).then(r => r.blob());
Â  Â  Â  Â  Â  Â  Â  Â  var file = new File([blob], `share_${i}.jpg`, { type: blob.type });
Â  Â  Â  Â  Â  Â  Â  Â  filesArray.push(file);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  } catch(e) { alert("åœ–ç‰‡ä¸‹è¼‰å¤±æ•—"); }
Â  Â  Â  Â  Â  loading(false);
Â  Â  Â  Â }
Â  Â  Â  Â if (navigator.canShare && navigator.canShare({ files: filesArray })) {
Â  Â  Â  Â  Â  navigator.share({ text: item.text, files: filesArray }).catch(() => {});
Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  alert("ä¸æ”¯æ´åŸç”Ÿåˆ†äº«ï¼Œæ–‡å­—å·²è¤‡è£½ã€‚");
Â  Â  Â  Â  Â  window.location.href = "https://line.me/R/msg/text/?" + encodeURIComponent(item.text);
Â  Â  Â  Â }
Â  Â  }

Â  Â  // ... CMS Logic ...
Â  Â  function switchAdminView(view) {
Â  Â  Â  Â ['promo', 'broadcast', 'report'].forEach(v => document.getElementById('adm-view-'+v).style.display = 'none');
Â  Â  Â  Â document.getElementById('adm-view-'+view).style.display = 'block';
Â  Â  }
Â  Â  function renderCmsList() {
Â  Â  Â  Â var html = "";
Â  Â  Â  Â shareDataList.forEach((item, idx) => {
Â  Â  Â  Â  Â  var statusIcon = item.isActive ? "ğŸ‘ï¸" : "ğŸ”’";
Â  Â  Â  Â  Â  var statusClass = item.isActive ? "" : "inactive";
Â  Â  Â  Â  Â  html += `<div class="cms-item ${statusClass}"><div class="cms-info"><div class="cms-title">${statusIcon} ${item.title}</div><div class="cms-desc">${item.text}</div></div><div class="cms-actions"><button onclick="manageShare('toggle', {index:${idx}})">${item.isActive?'éš±è—':'å•Ÿç”¨'}</button><button onclick="manageShare('move', {index:${idx}, direction:-1})">â¬†ï¸</button><button onclick="manageShare('move', {index:${idx}, direction:1})">â¬‡ï¸</button><button onclick="openCmsModal('edit', ${idx})">âœï¸</button><button onclick="manageShare('delete', {index:${idx}})" style="color:red;">ğŸ—‘ï¸</button></div></div>`;
Â  Â  Â  Â });
Â  Â  Â  Â document.getElementById('cms-list').innerHTML = html || "ç„¡å…§å®¹";
Â  Â  }
Â  Â  function openCmsModal(mode, idx) {
Â  Â  Â  Â var isAdd = mode === 'add';
Â  Â  Â  Â var item = isAdd ? {title:"", text:""} : shareDataList[idx];
Â  Â  Â  Â cmsUploadFiles = [];Â 
Â  Â  Â  Â var html = `<input id="cms-title" class="input-field" placeholder="æ¨™é¡Œ" value="${item.title}"><textarea id="cms-text" class="input-field" rows="4" placeholder="å®£å‚³æ–‡æ¡ˆ">${item.text}</textarea>${isAdd ? `<div style="margin-top:10px;"><label class="btn" style="background:#eee; color:#555; display:inline-block; width:auto; padding:5px 10px; font-size:12px;">ğŸ“· é¸æ“‡åœ–ç‰‡ (å¯å¤šå¼µ) <input type="file" multiple accept="image/*" style="display:none;" onchange="handleCmsFiles(this)"></label><div id="cms-preview" class="preview-grid"></div></div>` : ''}<button class="btn btn-primary" onclick="submitCms('${mode}', ${idx})">${isAdd?'ğŸš€ ç™¼å¸ƒ':'ğŸ’¾ æ›´æ–°'}</button>`;
Â  Â  Â  Â document.getElementById('modal-title').innerText = isAdd ? "æ–°å¢å®£å‚³" : "ç·¨è¼¯å…§å®¹";
Â  Â  Â  Â document.getElementById('modal-content').innerHTML = html;
Â  Â  Â  Â document.getElementById('modal-overlay').style.display = 'flex';
Â  Â  }
Â  Â  function handleCmsFiles(input) {
Â  Â  Â  Â cmsUploadFiles = [];
Â  Â  Â  Â document.getElementById('cms-preview').innerHTML = "";
Â  Â  Â  Â if(input.files) {
Â  Â  Â  Â  Â  for(var i=0; i<input.files.length; i++) {
Â  Â  Â  Â  Â  Â  Â var file = input.files[i];
Â  Â  Â  Â  Â  Â  Â var reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  cmsUploadFiles.push({ base64: e.target.result.split(',')[1], name: file.name });
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cms-preview').innerHTML += `<img src="${e.target.result}" class="preview-img">`;
Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â reader.readAsDataURL(file);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â }
Â  Â  }
Â  Â  function submitCms(mode, idx) {
Â  Â  Â  Â var title = document.getElementById('cms-title').value;
Â  Â  Â  Â var text = document.getElementById('cms-text').value;
Â  Â  Â  Â if(!title || !text) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }
Â  Â  Â  Â var payload = { title: title, text: text, index: idx };
Â  Â  Â  Â if(mode === 'add') { payload.images = cmsUploadFiles; }
Â  Â  Â  Â loading(true);
Â  Â  Â  Â callApi('manageShare', {subAction: mode, data: payload}).then(res => {
Â  Â  Â  Â  Â  loading(false);
Â  Â  Â  Â  Â  if(res.success) { alert(res.msg); closeModal(); loadShareData(); } else { alert("å¤±æ•—: " + res.msg); }
Â  Â  Â  Â });
Â  Â  }
Â  Â  function manageShare(action, data) {
Â  Â  Â  Â if(action === 'delete' && !confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
Â  Â  Â  Â loading(true);
Â  Â  Â  Â callApi('manageShare', {subAction: action, data: data}).then(res => {
Â  Â  Â  Â  Â  loading(false);
Â  Â  Â  Â  Â  if(res.success) loadShareData();
Â  Â  Â  Â });
Â  Â  }

Â  Â  // ğŸ”´ 3. è£œä¸Šæ‰€æœ‰æ¥­å‹™é‚è¼¯å‡½å¼ (é˜²æ­¢ ReferenceError)
Â  Â  function loadEvents() {
Â  Â  Â  Â document.getElementById('event-list').innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">è¼‰å…¥ä¸­...</div>';
Â  Â  Â  Â callApi('getYearlyEvents').then(res => {
Â  Â  Â  Â  Â  if(res.error) { document.getElementById('event-list').innerHTML = `<div style="text-align:center; color:#f44336;">${res.error}</div>`; return; }
Â  Â  Â  Â  Â  allEvents = res.list || [];
Â  Â  Â  Â  Â  var cats = res.cats || [];
Â  Â  Â  Â  Â  initFilters();
Â  Â  Â  Â  Â  var filterHtml = `<div class="chip ${activeFilters.length===0?'active':''}" onclick="toggleFilter('all', this)">å…¨éƒ¨</div>`;
Â  Â  Â  Â  Â  cats.forEach(c => { var isActive = activeFilters.includes(c) ? 'active' : ''; filterHtml += `<div class="chip ${isActive}" onclick="toggleFilter('${c}', this)">${c}</div>`; });
Â  Â  Â  Â  Â  document.getElementById('event-filters').innerHTML = filterHtml;
Â  Â  Â  Â  Â  renderEventList();
Â  Â  Â  Â });
Â  Â  }
Â  Â  function initFilters() { if(gData.teamMajor === "ä¸»é ˜ç­") { activeFilters = []; } else { activeFilters = ["ä¸­å¤®", "è³¢å¾·", "ä»™ä½›ç´€å¿µæ—¥"]; if(gData.teamMajor && gData.teamMajor.includes("è³¢")) { activeFilters.push(gData.teamMajor); } } }
Â  Â  function toggleFilter(cat, el) { if(cat === 'all') { activeFilters = []; var chips = document.querySelectorAll('.chip'); chips.forEach(c => c.classList.remove('active')); el.classList.add('active'); } else { document.querySelector('.chip:first-child').classList.remove('active'); if(activeFilters.includes(cat)) { activeFilters = activeFilters.filter(c => c !== cat); el.classList.remove('active'); } else { activeFilters.push(cat); el.classList.add('active'); } } renderEventList(); }
Â  Â  function renderEventList() { var today = new Date(); today.setHours(0,0,0,0); var html = ""; var hasScrolled = false; var historyAdded = false; var weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"]; allEvents.forEach((e, index) => { if(activeFilters.length > 0 && !activeFilters.includes(e.cat)) return; var dStart = new Date(e.date); var dEnd = new Date(e.end); var isPast = dEnd < today; var isTodayOrFuture = dEnd >= today; if(!historyAdded && isTodayOrFuture && index > 0) { html += `<div class="history-line">ä»¥ä¸Šæ˜¯æ­·å²æ´»å‹•</div>`; historyAdded = true; } var day = dStart.getDate(); var mon = dStart.getMonth() + 1; var weekStr = weekDays[dStart.getDay()]; var dateRangeStr = ""; if(e.date !== e.end) { var dEndDay = dEnd.getDate(); var dEndMon = dEnd.getMonth() + 1; dateRangeStr = `ğŸ“… ${mon}/${day} ~ ${dEndMon}/${dEndDay}`; day = `${day}-${dEndDay}`; var diffTime = dStart - today; var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if(diffDays > 0) dateRangeStr += ` (é‚„æœ‰${diffDays}å¤©)`; else if(diffDays <= 0 && dEnd >= today) dateRangeStr += ` (é€²è¡Œä¸­)`; } else { var diffTime = dStart - today; var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if(diffDays === 0) dateRangeStr = "<span style='color:red; font-weight:bold;'>ä»Šå¤©!</span>"; else if(diffDays > 0) dateRangeStr = `é‚„æœ‰ ${diffDays} å¤©`; else dateRangeStr = "å·²çµæŸ"; } var cardId = ""; if(!hasScrolled && isTodayOrFuture) { cardId = "id='today-focus'"; hasScrolled = true; } var noteHtml = e.note ? `<div class="event-note">${e.note}</div>` : ""; html += `<div ${cardId} class="event-card ${isPast?'past':''} ${cardId?'focus':''}"><div class="event-date-box" style="border-left: 5px solid ${getTagColor(e.cat)}"><div class="event-month">${mon}æœˆ</div><div class="event-day" style="font-size:${day.toString().length>2?'14px':'18px'}">${day}</div><div style="font-size:10px; margin-top:-2px;">é€±${weekStr}</div></div><div class="event-info"><div class="event-title">${e.name}</div>${noteHtml}<div class="event-meta"><span class="tag" style="background:${getTagColor(e.cat)}">${e.cat}</span><span>ğŸ“ ${e.loc || "--"}</span><span style="flex:1; text-align:right; font-size:10px; color:#999;">${dateRangeStr}</span></div></div></div>`; }); document.getElementById('event-list').innerHTML = html || "<div style='text-align:center; color:#999; padding:20px;'>æ²’æœ‰æ´»å‹•</div>"; setTimeout(() => { var focusEl = document.getElementById('today-focus'); if(focusEl) focusEl.scrollIntoView({behavior: "smooth", block: "center"}); }, 300); }
Â  Â  function getTagColor(cat) { if(!cat) return "#ccc"; if(cat.includes("ä»™ä½›")) return "#fbc02d"; if(cat.includes("è³¢å¾·")) return "#8bc34a"; if(cat.includes("ä¸­å¤®")) return "#ff7043"; if(cat.includes("ä¸­") || cat.includes("åŒ—") || cat.includes("å—")) return "#29b6f6"; return "#9e9e9e"; }
Â  Â Â 
Â  Â  function loadCRM(targetUser) { var u = targetUser || gUser; if(!targetUser) document.getElementById('crm-list').innerHTML = '<div style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</div>'; callApi('getCRM', {u:gUser, target:u}).then(res => { if(res.error) { alert(res.error); return; } var list = res.list || []; if(targetUser) { var html = `<h4>ğŸ‘¤ ${targetUser} çš„è¨˜äº‹æœ¬</h4>`; if(list.length === 0) html += "<p>å°šç„¡è³‡æ–™</p>"; list.forEach(item => { var stClass = "s-plan"; if(item.status.includes("é–‹å£")) stClass = "s-spoke"; if(item.status.includes("å…¥ç­") || item.status.includes("æ±‚é“")) stClass = "s-join"; var rInfo = item.remind ? `<br><small>â° ${item.remind} (${item.repeat})</small>` : ""; html += `<div class="crm-card" style="pointer-events:none; background:#f9f9f9;"><div class="crm-header"><div class="crm-name">${item.name}</div><div class="crm-status ${stClass}">${item.status}</div></div><div class="crm-note">${item.todo ? "ğŸ“ å¾…è¾¦: " + item.todo : (item.note || "ç„¡å‚™è¨»")}${rInfo}</div></div>`; }); document.getElementById('modal-content').innerHTML = html; } else { crmData = list; renderCRM(); } }); }
Â  Â  function renderCRM() { var todoHtml = "", listHtml = ""; crmData.forEach(item => { if(item.todo) { todoHtml += `<div class="todo-item"><input type="checkbox" class="todo-check" onclick="completeTodo(${item.id})"><div class="todo-text"><div style="font-weight:bold;">${item.name}</div><div>${item.todo}</div></div></div>`; } var stClass = "s-plan"; if(item.status.includes("é–‹å£")) stClass = "s-spoke"; if(item.status.includes("å…¥ç­") || item.status.includes("æ±‚é“")) stClass = "s-join"; var rIcon = item.remind ? "â°" : ""; listHtml += `<div class="crm-card" onclick='editCRM(${JSON.stringify(item).replace(/'/g, "'")})'><div class="crm-header"><div class="crm-name">${item.name} ${rIcon}</div><div class="crm-status ${stClass}">${item.status}</div></div><div class="crm-note">${item.todo ? "ğŸ“ " + item.todo : (item.note || "ç„¡å‚™è¨»")}</div></div>`; }); document.getElementById('crm-todo-list').innerHTML = todoHtml || '<div style="text-align:center; color:#999; font-size:12px;">ç„¡å¾…è¾¦äº‹é …</div>'; document.getElementById('crm-list').innerHTML = listHtml || '<div style="text-align:center; color:#999; margin-top:20px;">é»æ“Šå³ä¸‹è§’ + æ–°å¢åå–®</div>'; }
Â  Â  function editCRM(item) { var title = item ? "ç·¨è¼¯è³‡æ–™" : "æ–°å¢åå–®"; var isNew = !item; item = item || { id:0, name:"", status:"é è¨ˆæ¸¡çœ¾", todo:"", note:"", remind:"", repeat:"none" }; var html = `<input id="e-id" type="hidden" value="${item.id}"><div style="margin-bottom:10px;"><label>å§“å</label><input id="e-name" class="input-field" value="${item.name}" placeholder="å°è±¡å§“å"></div><div style="margin-bottom:10px;"><label>ç‹€æ…‹</label><select id="e-status" class="input-field"><option ${item.status=='é è¨ˆæ¸¡çœ¾'?'selected':''}>é è¨ˆæ¸¡çœ¾</option><option ${item.status=='å·²é–‹å£'?'selected':''}>å·²é–‹å£</option><option ${item.status=='è·Ÿé€²ä¸­'?'selected':''}>è·Ÿé€²ä¸­</option><option ${item.status=='å·²æ±‚é“'?'selected':''}>å·²æ±‚é“</option><option ${item.status=='å·²å…¥ç­'?'selected':''}>å·²å…¥ç­</option></select></div><div style="margin-bottom:10px;"><label>ä¸‹ä¸€æ­¥ / å¾…è¾¦</label><input id="e-todo" class="input-field" value="${item.todo}" placeholder="ä¾‹å¦‚ï¼šç´„åƒé£¯ã€é€æ›¸"></div><div style="margin-bottom:10px; background:#f0f4c3; padding:10px; border-radius:10px;"><label>â° è¨­å®šæé†’ (é¸å¡«)</label><input id="e-remind" type="datetime-local" class="input-field" value="${item.remind}"><label>é‡è¤‡é »ç‡</label><select id="e-repeat" class="input-field"><option value="none" ${item.repeat=='none'?'selected':''}>å–®æ¬¡æé†’</option><option value="daily" ${item.repeat=='daily'?'selected':''}>æ¯å¤©</option><option value="weekly" ${item.repeat=='weekly'?'selected':''}>æ¯é€±</option><option value="monthly" ${item.repeat=='monthly'?'selected':''}>æ¯æœˆ</option></select></div><div style="margin-bottom:15px;"><label>å‚™è¨»</label><textarea id="e-note" class="input-field" rows="3">${item.note}</textarea></div><button class="btn btn-primary" onclick="saveCRMItem()">ğŸ’¾ å„²å­˜</button>${!isNew ? `<button class="btn" style="background:#eee; color:#f44336; margin-top:10px;" onclick="deleteCRMItem(${item.id})">ğŸ—‘ï¸ åˆªé™¤</button>` : ''}`; document.getElementById('modal-title').innerText = title; document.getElementById('modal-content').innerHTML = html; document.getElementById('modal-overlay').style.display = 'flex'; }
Â  Â  function saveCRMItem() { var item = { id: document.getElementById('e-id').value, name: document.getElementById('e-name').value, status: document.getElementById('e-status').value, todo: document.getElementById('e-todo').value, note: document.getElementById('e-note').value, remind: document.getElementById('e-remind').value, repeat: document.getElementById('e-repeat').value }; if(!item.name) { alert("è«‹è¼¸å…¥å§“å"); return; } loading(true); callApi('saveCRM', {u:gUser, item:item}).then(res => { loading(false); closeModal(); loadCRM(); }); }
Â  Â  function deleteCRMItem(id) { if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è³‡æ–™å—ï¼Ÿ")) return; loading(true); callApi('deleteCRM', {u:gUser, idx:id}).then(res => { loading(false); closeModal(); loadCRM(); }); }
Â  Â  function completeTodo(id) { if(!confirm("å®Œæˆæ­¤å¾…è¾¦äº‹é …ï¼Ÿ")) return; var item = crmData.find(x => x.id == id); if(item) { item.todo = ""; loading(true); callApi('saveCRM', {u:gUser, item:item}).then(res => { loading(false); loadCRM(); }); } }
Â  Â  function openAdminCRM(userName) { document.getElementById('modal-overlay').style.display = 'flex'; document.getElementById('modal-title').innerText = "è¼‰å…¥ä¸­..."; document.getElementById('modal-content').innerHTML = "è«‹ç¨å€™..."; loadCRM(userName); }
Â  Â Â 
Â  Â  // ğŸ”´ æ ¸å¿ƒä¿®å¾©ï¼šçµ±ä¸€å‘½åç‚º initAdminDropdowns
Â  Â  function initRegDropdowns(){ var s=document.getElementById('r-maj'), opts="<option disabled selected>é¸æ“‡åœ˜éšŠ</option>"; for(var k in menuConfig){ opts += `<option value="${k}">${k}</option>`; } s.innerHTML = opts; }
Â  Â  function initAdminDropdowns(){ var s=document.getElementById('adm-maj'), opts="<option value='å…¨éƒ¨'>å…¨éƒ¨åœ˜éšŠ</option>"; for(var k in menuConfig){ opts += `<option value="${k}">${k}</option>`; } s.innerHTML = opts; admUpdMin(); }
Â  Â Â 
Â  Â  // ğŸ”´ ä¿®æ­£å‘¼å«
Â  Â  function loadAdminFilters() {Â 
Â  Â  Â  Â  if(Object.keys(menuConfig).length > 0) {Â 
Â  Â  Â  Â  Â  Â  initAdminDropdowns();Â 
Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  callApi('getConfig').then(cfg => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  menuConfig = cfg.menu;Â 
Â  Â  Â  Â  Â  Â  Â  Â  initAdminDropdowns();Â 
Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  }Â 
Â  Â  }
Â  Â Â 
Â  Â  function updMinor(){ var m=document.getElementById('r-maj').value, s=document.getElementById('r-min'); s.innerHTML=""; if(menuConfig[m]) menuConfig[m].forEach(x => { var o=document.createElement('option'); o.value=x; o.innerText=x; s.appendChild(o); }); }
Â  Â  function admUpdMin(){ var m=document.getElementById('adm-maj').value, s=document.getElementById('adm-min'); s.innerHTML="<option value='å…¨éƒ¨'>å…¨éƒ¨å…¬å ‚</option>"; if(m !== 'å…¨éƒ¨' && menuConfig[m]) { menuConfig[m].forEach(x => { var o=document.createElement('option'); o.value=x; o.innerText=x; s.appendChild(o); }); } }
Â  Â  function toggleAuth(t){ document.getElementById('f-login').style.display=t=='login'?'block':'none'; document.getElementById('f-reg').style.display=t=='register'?'block':'none'; }
Â  Â  function nav(t){ ['home','orchard','profile','admin','crm','events'].forEach(x=>{ document.getElementById('v-'+x).classList.remove('active'); document.getElementById('n-'+x).classList.remove('active'); }); document.getElementById('v-'+t).classList.add('active'); document.getElementById('n-'+t).classList.add('active'); }
Â  Â  function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
Â  Â  function toggleAdmDateInput() { var mode = document.getElementById('adm-mode').value; document.getElementById('adm-date-box').style.display = mode==='date' ? 'block' : 'none'; document.getElementById('adm-month-box').style.display = mode==='month' ? 'block' : 'none'; }
Â  Â  function doReg(){ var u=document.getElementById('r-u').value, p=document.getElementById('r-p').value, maj=document.getElementById('r-maj').value, min=document.getElementById('r-min').value; if(!u||!p||!maj||!min){ alert("è«‹å¡«å¯«å®Œæ•´"); return; } loading(true); callApi('register', {u:u, p:p, maj:maj, min:min}).then(r => { loading(false); alert(r.msg); if(r.success) toggleAuth('login'); }); }
Â  Â  function doLogin(){ var u=document.getElementById('l-u').value, p=document.getElementById('l-p').value; loading(true); callApi('login', {u:u, p:p}).then(r => { loading(false); if(r.success){ gUser=u; gPass=p; gData=r.gameData; localStorage.setItem("xd_u",u); localStorage.setItem("xd_p",p); if(window.OneSignal) OneSignal.User.addTag("user", u); loadShareData(); lastLogTime = new Date().getTime(); if(gData.teamMajor === "ä¸»é ˜ç­") { document.getElementById('n-admin').style.display = 'block'; } enterGame(); } else { alert(r.msg); } }); }
Â  Â  function enterGame(){ document.getElementById('auth-screen').style.display='none'; document.getElementById('game-screen').style.display='flex'; renderUI(); }
Â  Â  function logout(){ if(confirm("ç™»å‡º?")){ localStorage.removeItem("xd_p"); location.reload(); } }
Â  Â  function renderUI(){ document.getElementById('ui-team').innerText = gData.teamFull; document.getElementById('p-job').innerText = gData.job; updateDashboard(); var ck = document.getElementById('ck-sport'); if(gData.task_sport_done){ ck.style.background='var(--primary)'; ck.style.borderColor='var(--primary)'; } else { ck.style.background='transparent'; ck.style.borderColor='#ddd'; } updTimer(gData.task_read_time||0); }
Â  Â  function addCount(id) { var el = document.getElementById(id); el.value = parseInt(el.value || 0) + 1; updateDashboard(); }
Â  Â  function minusCount(id) { var el = document.getElementById(id); var val = parseInt(el.value || 0); if (val > 0) { el.value = val - 1; updateDashboard(); } }
Â  Â  function updateDashboard() { var addS = parseInt(document.getElementById('inp-spoke').value||0); var addC = parseInt(document.getElementById('inp-conv').value||0); var addCl = parseInt(document.getElementById('inp-class').value||0); var totalS = (gData.spoke_count||0) + addS; var totalC = (gData.convert_count||0) + addC; var totalCl = (gData.class_count||0) + addCl; document.getElementById('today-dash').innerText = `ğŸ“Š ä»Šæ—¥å·²ç´¯ç©ï¼šé–‹å£ ${totalS} | æ¸¡çœ¾ ${totalC} | å…¥ç­ ${totalCl}`; }
Â  Â  function toggleTimer(){ var b = document.getElementById('btn-timer'); if(isTimer){ clearInterval(timerInt); isTimer=false; b.innerText="ç¹¼çºŒè¨ˆæ™‚"; b.className="btn btn-primary"; saveData({action:"è®€æ›¸", detail:"ç´¯è¨ˆ "+Math.floor(gData.task_read_time/60)+" åˆ†é˜"}); } else { timerInt = setInterval(function(){ gData.task_read_time=(gData.task_read_time||0)+1; updTimer(gData.task_read_time); }, 1000); isTimer=true; b.innerText="æš«åœè¨ˆæ™‚"; b.className="btn btn-warn"; } }
Â  Â  function updTimer(s){ var m=Math.floor(s/60), sec=s%60; document.getElementById('timer-display').innerText = (m<10?"0"+m:m)+":"+(sec<10?"0"+sec:sec); }
Â  Â  function toggleSport(){ if(gData.task_sport_done) return; gData.task_sport_done = true; renderUI(); saveData({action:"é‹å‹•", detail:"å®Œæˆä»Šæ—¥30åˆ†é˜é‹å‹•ï¼"}); }
Â  Â  function saveAchievements(){ var addS = parseInt(document.getElementById('inp-spoke').value||0); var addC = parseInt(document.getElementById('inp-conv').value||0); var addCl = parseInt(document.getElementById('inp-class').value||0); if(addS==0 && addC==0 && addCl==0) { alert("è«‹è¼¸å…¥æ•¸é‡"); return; } gData.spoke_count = (gData.spoke_count||0) + addS; gData.convert_count = (gData.convert_count||0) + addC; gData.class_count = (gData.class_count||0) + addCl; loading(true); var msg = `é–‹å£${addS}, æ¸¡çœ¾${addC}, å…¥ç­${addCl}`; callApi('saveGameData', {u:gUser, p:gPass, data:gData, log:{action:"å›å ±æˆæœ", detail: msg}}).then(r => { loading(false); document.getElementById('inp-spoke').value=0; document.getElementById('inp-conv').value=0; document.getElementById('inp-class').value=0; renderUI(); alert("ğŸ“œ ç´€éŒ„å·²åŒæ­¥ï¼"); }); }
Â  Â  function saveData(logObj){ callApi('saveGameData', {u:gUser, p:gPass, data:gData, log:logObj}); }
Â  Â  function setLocalReminder() { var t = document.getElementById('reminder-time').value; localStorage.setItem("reminder_time", t); if('Notification' in window) Notification.requestPermission(); alert("æé†’æ™‚é–“å·²è¨­å®šç‚º " + t); }
Â  Â Â 
Â  Â  // ğŸ”´ ç¼ºå°‘çš„å‡½å¼è£œå®Œäº†
Â  Â  function changeMonth(delta) {Â 
Â  Â  Â  Â  curMonth += delta;Â 
Â  Â  Â  Â  if(curMonth > 12) { curMonth = 1; curYear++; }Â 
Â  Â  Â  Â  if(curMonth < 1) { curMonth = 12; curYear--; }Â 
Â  Â  Â  Â  loadCalendar();Â 
Â  Â  }
Â  Â Â 
Â  Â  function loadCalendar() {Â 
Â  Â  Â  Â  var mStr = curYear + "-" + (curMonth<10?"0"+curMonth:curMonth);Â 
Â  Â  Â  Â  document.getElementById('cal-title').innerText = mStr;Â 
Â  Â  Â  Â  document.getElementById('calendar-area').innerHTML = "Loading...";Â 
Â  Â  Â  Â  document.getElementById('profile-stats').innerHTML = "";Â 
Â  Â  Â  Â  document.getElementById('profile-log-list').innerHTML = "";Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  callApi('getCalendarData', {u:gUser, year:curYear, month:curMonth}).then(res => {Â 
Â  Â  Â  Â  Â  Â  var daysInMonth = new Date(curYear, curMonth, 0).getDate();Â 
Â  Â  Â  Â  Â  Â  var html = "";Â 
Â  Â  Â  Â  Â  Â  for(var d=1; d<=daysInMonth; d++) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  var dStr = mStr + "-" + (d<10?"0"+d:d);Â 
Â  Â  Â  Â  Â  Â  Â  Â  var dayData = res.cal[dStr];Â 
Â  Â  Â  Â  Â  Â  Â  Â  var cls = "cal-day";Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(dayData) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  var count = 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(dayData.read) count++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(dayData.sport) count++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(dayData.achieve) count++;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(count > 0) cls += " cal-fill-" + count;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="${cls}">${d}</div>`;Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  document.getElementById('calendar-area').innerHTML = html;Â 
Â  Â  Â  Â  Â  Â  var s = res.stats;Â 
Â  Â  Â  Â  Â  Â  document.getElementById('profile-stats').innerHTML = `<b>ğŸ“Š ${mStr} æœˆå ±è¡¨</b><br>é‹å‹•: ${s.sportDays}å¤© | è®€æ›¸: ${s.readDays}å¤© | é–‹å£: ${s.totalSpoke}`;Â 
Â  Â  Â  Â  Â  Â  var logHtml = res.logs.map(l => `<div class="log-item"><div class="log-time" style="width:80px;">${l.time}</div><div class="log-content"><b>${l.action}</b> ${l.detail}</div></div>`).join('');Â 
Â  Â  Â  Â  Â  Â  document.getElementById('profile-log-list').innerHTML = logHtml || "ç„¡ç´€éŒ„";Â 
Â  Â  Â  Â  });Â 
Â  Â  }
Â  Â Â 
Â  Â  function loadOrchard(){ document.getElementById('orchard-container').innerHTML = 'Loading...'; callApi('getOrchardData').then(data => { var html = ""; for(var key in data){ var h = data[key]; var fruits = ""; var sp = Number(h.spoke)||0; var cv = Number(h.convert)||0; var cl = Number(h.joinClass)||0; var redFruits = Math.floor(sp / 10); var totalPoints = redFruits + cv + cl; var treeClass = "tree-scale-s"; if(totalPoints > 20) treeClass = "tree-scale-l"; else if(totalPoints > 5) treeClass = "tree-scale-m"; for(var i=0; i<redFruits && i<10; i++) fruits += '<div class="fruit red"></div>'; for(var i=0; i<cv && i<10; i++) fruits += '<div class="fruit gold"></div>'; for(var i=0; i<cl && i<10; i++) fruits += '<div class="fruit blue"></div>'; if(totalPoints == 0) fruits = '<span style="font-size:10px; color:#fff;">ç¨®å­</span>'; var info = `é–‹å£:${sp} æ¸¡çœ¾:${cv} å…¥ç­:${cl}`; html += `<div class="tree-container ${treeClass}" onclick="openHallModal('${h.name}', '${info}')"><div class="tree-canopy">${fruits}</div><div class="tree-trunk"></div><div class="tree-label">${h.name}<br><span style="font-size:10px;">${h.members}äºº</span></div></div>`; } document.getElementById('orchard-container').innerHTML = html || "ç„¡è³‡æ–™"; if(document.getElementById('dash-spoke')) { document.getElementById('dash-spoke').innerText = data.totalSpoke || 0; document.getElementById('dash-conv').innerText = data.totalConv || 0; document.getElementById('dash-class').innerText = data.totalClass || 0; } loadGlobalLogs(); }); }
Â  Â  function openHallModal(name, info) { document.getElementById('modal-overlay').style.display = 'flex'; document.getElementById('modal-title').innerText = name; document.getElementById('modal-content').innerHTML = `<div style="background:#f1f8e9; padding:10px; border-radius:10px; margin-bottom:10px;"><b>ğŸ“Š å…¬å ‚ç¸½æˆç¸¾</b><br>${info}</div><div id="hall-members">æˆå“¡è¼‰å…¥ä¸­...</div>`; callApi('getHallDetails', {hall:name}).then(res => { var h = res.list.map(m => `<div class="member-row"><span>${m.name}</span><span>é–‹${m.s}/æ¸¡${m.c}/ç­${m.cl}</span></div>`).join(''); document.getElementById('hall-members').innerHTML = h; }); }
Â  Â  function updateMarquee() { var msg = document.getElementById('adm-marquee').value; if(!msg) return; callApi('updateMarquee', {msg:msg}).then(r => { alert(r.msg); document.getElementById('marquee-text').innerText = msg; }); }
Â  Â  function runAdminQuery() { try { if(Object.keys(menuConfig).length === 0) { alert("ç³»çµ±è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦..."); return; } var filters = { major: document.getElementById('adm-maj').value, minor: document.getElementById('adm-min').value, hasSport: document.getElementById('f-sport').checked, hasRead: document.getElementById('f-read').checked, hasSpoke: document.getElementById('f-spoke').checked, hasConv: document.getElementById('f-conv').checked, hasClass: document.getElementById('f-class').checked }; var mode = document.getElementById('adm-mode').value; var dateVal = ""; if(mode === 'date') dateVal = document.getElementById('adm-date').value; if(mode === 'month') dateVal = document.getElementById('adm-month').value; loading(true); callApi('getAdminReport', {filters:filters, mode:mode, dateVal:dateVal}).then(res => { loading(false); if(res.error) { alert("ç³»çµ±éŒ¯èª¤: " + res.error); return; } if(!res.list || res.list.length === 0) { document.getElementById('admin-report').style.display = 'block'; document.getElementById('admin-report').innerHTML = "<div style='text-align:center; color:#666; padding:10px;'>âš ï¸ æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>"; document.getElementById('admin-list').innerHTML = ""; return; } var st = res.stats; var repHtml = `<div><b>[${mode === 'all' ? 'å…¨éƒ¨æ­·å²' : dateVal}]</b></div><div>ç¯©é¸äººæ•¸: <b>${st.count}</b></div><div>ç´¯è¨ˆé–‹å£: ${st.totalSpoke} | æ¸¡çœ¾: ${st.totalConv} | å…¥ç­: ${st.totalClass}</div><div>é‹å‹•äººæ¬¡: ${st.totalSport}</div>`; document.getElementById('admin-report').innerHTML = repHtml; document.getElementById('admin-report').style.display = 'block'; var listHtml = res.list.map(u => { var badges = ""; if(u.sportCount > 0) badges += `<span style='background:#8bc34a'>é‹${u.sportCount}</span>`; if(u.readCount > 0) badges += `<span style='background:#81d4fa'>è®€${u.readCount}</span>`; if(u.spoke > 0) badges += `<span style='background:#ff8a80'>é–‹${u.spoke}</span>`; if(u.conv > 0) badges += `<span style='background:#ffd54f'>æ¸¡${u.conv}</span>`; return `<div class="admin-row"><div style="flex:1"><div style="font-weight:bold;">${u.name} <span onclick="openAdminCRM('${u.name}')" style="cursor:pointer; margin-left:5px;">ğŸ“’</span></div><div style="font-size:10px; color:#999;">${u.minor}</div></div><div class="admin-stat-badges" style="text-align:right;">${badges}</div></div>`; }).join(''); document.getElementById('admin-list').innerHTML = listHtml; }).catch(err => { loading(false); alert("é€£ç·šå¤±æ•—: " + err); }); } catch(e) { loading(false); alert("å‰ç«¯éŒ¯èª¤: " + e.message); } }
Â  Â  function sendBroadcast() { var msg = document.getElementById('broadcast-msg').value; if (!msg) { alert("è«‹è¼¸å…¥è¨Šæ¯å…§å®¹"); return; } var time = document.getElementById('broadcast-time').value; if(confirm("ç¢ºå®šè¦ç™¼é€é€™å‰‡é€šçŸ¥çµ¦æ‰€æœ‰äººå—ï¼Ÿ")) { loading(true); callApi('broadcast', {msg: msg, time: time}).then(res => { loading(false); if (res.success) { alert("ç™¼é€æˆåŠŸ"); document.getElementById('broadcast-msg').value = ""; } else { alert("ç™¼é€å¤±æ•—: " + res.msg); } }); } }
Â  Â  function loadGlobalLogs(){ var c = document.getElementById('log-container'); c.innerHTML = '<div style="padding:20px; text-align:center;">è®€å–ä¸­...</div>'; callApi('getGlobalLogs').then(res => { var h = ""; if(res.list.length==0) h='<div style="padding:20px; text-align:center;">å°šç„¡ç´€éŒ„</div>'; res.list.forEach(function(l){ var color = "#eee"; if(l.action.includes("é‹å‹•")) color="#e8f5e9"; if(l.action.includes("è®€æ›¸")) color="#e3f2fd"; if(l.action.includes("å›å ±")) color="#fff3e0"; h += `<div class="log-item"><div class="log-time">${l.time}</div><div class="log-content"><span style="font-weight:bold; color:#555;">${l.user}</span> <span class="log-tag" style="background:${color}">${l.action}</span><span>${l.detail}</span><div style="font-size:9px; color:#bbb;">(${l.hall})</div></div></div>`; }); c.innerHTML = h; }); }
Â  </script>
</body>
</html>
